<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Secure Tokenize → Server Process</title>

  <script src="https://js.stripe.com/v3/"></script>

  <style>
    :root{
      --bg: #f4f7fb;
      --card: #ffffff;
      --muted: #6b7280;
      --accent1: #667eea;
      --accent2: #764ba2;
      --radius: 12px;
      --shadow: 0 12px 30px rgba(17,24,39,0.06);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg);
      color: #0f172a;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      padding:24px;
    }

    .card {
      width:100%;
      max-width:720px;
      background:var(--card);
      border-radius:16px;
      box-shadow: var(--shadow);
      padding:22px;
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:18px;
    }

    .panel { padding:6px 4px; }
    h1 { margin:0 0 6px 0; font-size:20px; }
    p.lead { margin:0 0 14px 0; color:var(--muted); font-size:13px; }

    .form-card {
      background: linear-gradient(180deg,#fff,#fbfdff);
      border-radius:12px;
      padding:14px;
      border:1px solid rgba(99,102,241,0.04);
    }

    label { display:block; margin-bottom:6px; color:var(--muted); font-size:13px; }
    .stripe-element {
      padding:12px;
      border-radius:10px;
      border:1px solid #e6eef8;
      background:#fbfdff;
    }
    .actions { margin-top:12px; display:flex; gap:8px; align-items:center; }

    .btn {
      background: linear-gradient(90deg,var(--accent1),var(--accent2));
      color:#fff;
      border:none;
      padding:11px 14px;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
    }
    .btn.secondary {
      background:transparent;
      border:1px solid #e6eef8;
      color:#0f172a;
    }
    .btn[disabled]{ opacity:0.6; cursor:not-allowed; }

    .right-panel {
      background: #fff;
      border-radius:12px;
      padding:14px;
      border:1px solid rgba(99,102,241,0.04);
      height:100%;
      display:flex;
      flex-direction:column;
    }

    .result { margin-top:8px; font-family:monospace; font-size:13px; background:#0f172a; color:#e6eef8; padding:12px; border-radius:8px; overflow:auto; max-height:520px; white-space:pre-wrap; }

    .hint { font-size:12px; color:var(--muted); margin-top:8px; }

    @media (max-width:900px){
      .card{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="card" role="main">
    <div class="panel">
      <h1>Tokenize card & process (client → server)</h1>
      <p class="lead">Enter card details below. The card will be tokenized in the browser, the token will be immediately sent to your server API which will do customer → charge → refund. The server result is shown on this page.</p>

      <div class="form-card">
        <label for="pk">Publishable key (pk_...)</label>
        <input id="pk" class="stripe-element" placeholder="pk_live_..." />

        <label style="margin-top:12px;">Card</label>
        <div id="card-element" class="stripe-element"></div>

        <div class="actions">
          <button id="tokenizeBtn" class="btn">Tokenize & Send to API</button>
          <button id="clearBtn" class="btn secondary" type="button">Clear</button>
        </div>

        <div class="hint">If your server expects GET instead of POST, the client will try GET fallback (query string). Make sure your server path is: <code>https://phop.onrender.com/gateway=skbased/key=rockysoon</code></div>
      </div>
    </div>

    <div class="panel right-panel">
      <div style="font-weight:700; margin-bottom:8px;">Server Response / Debug</div>
      <div id="result" class="result">Result will appear here after processing...</div>
    </div>
  </div>

<script>
(async ()=>{

// ---------- CONFIG ----------
const API_ENDPOINT_BASE = "https://phop.onrender.com/gateway=skbased/key=rockysoon";
// The endpoint above should accept a POST JSON body { token: "tok_xxx" } OR accept GET ?token=tok_xxx
// Your server should use the token immediately (single-use).

// ---------- UI ----------
const pkInput = document.getElementById('pk');
const tokenizeBtn = document.getElementById('tokenizeBtn');
const clearBtn = document.getElementById('clearBtn');
const resultEl = document.getElementById('result');

let stripe = null;
let elements = null;
let card = null;

function setResult(text){ resultEl.textContent = text; }
function setHtmlResult(obj){ resultEl.textContent = JSON.stringify(obj, null, 2); }

// init with default PK if you want
pkInput.value = "pk_live_51049Hm4QFaGycgRKOIbupRw7rf65FJESmPqWZk9Jtpf2YCvxnjMAFX7dOPAgoxv9M2wwhi5OwFBx1EzuoTxNzLJD00ViBbMvkQ";

// Initialize Stripe Elements with the pk from input
function initStripe(pk){
  // cleanup existing
  if(card){ card.unmount(); card = null; elements = null; stripe = null; }

  try {
    stripe = Stripe(pk);
    elements = stripe.elements();
    const style = {
      base: { fontSize: '16px', color: '#0f172a', '::placeholder': { color: '#6b7280' } },
      invalid: { color: '#f87171' }
    };
    card = elements.create('card', { style, hidePostalCode: true });
    card.mount('#card-element');
    card.on('change', (e)=> {
      if(e.error) setResult("Card input error: " + e.error.message);
    });
    setResult("Ready — enter card and click Tokenize & Send to API");
  } catch (err){
    setResult("Stripe init error: " + err.message);
  }
}

// initialize on load
initStripe(pkInput.value.trim());

// re-init when PK changed (manual)
let pkTimer = null;
pkInput.addEventListener('input', ()=> {
  clearTimeout(pkTimer);
  pkTimer = setTimeout(()=> {
    const pk = pkInput.value.trim();
    if(pk) initStripe(pk);
  }, 600);
});

clearBtn.addEventListener('click', ()=> {
  // simple page reset
  initStripe(pkInput.value.trim());
  setResult("Cleared. Ready.");
});

// Tokenize + send
tokenizeBtn.addEventListener('click', async (e)=>{
  tokenizeBtn.disabled = true;
  setResult("Tokenizing card...");

  if(!stripe || !card){
    setResult("Stripe Elements not initialized. Check your publishable key.");
    tokenizeBtn.disabled = false;
    return;
  }

  // create token from element
  const { token, error } = await stripe.createToken(card);

  if(error){
    setResult("Stripe tokenization error:\n" + (error.message || JSON.stringify(error)));
    tokenizeBtn.disabled = false;
    return;
  }

  // show token immediately
  setResult("Token created: " + token.id + "\n\nSending token to server...");
  const payload = { token: token.id };

  // try POST first
  try {
    const resp = await fetch(API_ENDPOINT_BASE, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
      credentials: "omit"
    });

    // if server returns text/html, try to display text; if JSON, parse
    const ct = resp.headers.get("content-type") || "";
    let bodyText;
    if(ct.includes("application/json")){
      const j = await resp.json();
      setHtmlResult(j);
    } else {
      bodyText = await resp.text();
      // try JSON parse if looks like JSON
      try {
        const maybe = JSON.parse(bodyText);
        setHtmlResult(maybe);
      } catch(err){
        setResult(bodyText);
      }
    }

    tokenizeBtn.disabled = false;
    return;
  } catch (errPost) {
    // POST failed (network or server doesn't accept POST). Try GET fallback.
    setResult("POST failed, trying GET fallback...\nError: " + errPost);
  }

  // GET fallback (append token as query param)
  try {
    // encode token safely
    const url = API_ENDPOINT_BASE + "?token=" + encodeURIComponent(token.id);
    const resp2 = await fetch(url, { method: "GET" });
    const text = await resp2.text();
    try {
      const j = JSON.parse(text);
      setHtmlResult(j);
    } catch (err) {
      setResult(text);
    }
  } catch (err2) {
    setResult("Both POST and GET failed: " + err2);
  } finally {
    tokenizeBtn.disabled = false;
  }
});

})();
</script>
</body>
</html>
